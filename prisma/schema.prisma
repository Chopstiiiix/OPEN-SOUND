generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  role      Role     @default(FAN)
  country   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wallet            Wallet?
  creatorProfile    CreatorProfile?
  listeningSessions ListeningSession[]
}

model CreatorProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  stageName String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  campaigns Campaign[]
}

model Campaign {
  id               String         @id @default(cuid())
  creatorId         String
  name             String
  status           CampaignStatus @default(ACTIVE)

  budgetPoints      Int
  spentPoints       Int @default(0)
  costPerListen     Int

  minListenSeconds  Int @default(30)
  maxRewardsPerUser Int @default(1)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  creator           CreatorProfile @relation(fields: [creatorId], references: [id])
  tracks            Track[]
}

model Track {
  id          String   @id @default(cuid())
  campaignId  String
  title       String
  artistName  String
  audioUrl    String
  coverUrl    String?
  durationSec Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  campaign    Campaign @relation(fields: [campaignId], references: [id])
  sessions    ListeningSession[]
}

model ListeningSession {
  id              String        @id @default(cuid())
  userId          String
  trackId         String

  startedAt       DateTime      @default(now())
  completedAt     DateTime?
  status          SessionStatus  @default(STARTED)

  progressSec     Int           @default(0)
  completionPct   Int           @default(0)

  ipHash          String?
  deviceHash      String?
  userAgentHash   String?

  rewardedLedgerId String?      @unique

  user            User          @relation(fields: [userId], references: [id])
  track           Track         @relation(fields: [trackId], references: [id])

  @@index([userId, trackId])
  @@index([startedAt])
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  ledger    WalletLedger[]
}

model WalletLedger {
  id          String     @id @default(cuid())
  walletId    String
  amount      Int
  type        LedgerType
  referenceId String?
  createdAt   DateTime   @default(now())

  wallet      Wallet     @relation(fields: [walletId], references: [id])

  @@index([walletId, createdAt])
}

model FraudRuleConfig {
  id                 String   @id @default(cuid())
  dailyRewardCap     Int      @default(30)
  maxSessionsPerHour Int      @default(40)
  minHeartbeatGapMs  Int      @default(2500)
  updatedAt          DateTime @updatedAt
}

enum Role {
  FAN
  CREATOR
  ADMIN
}

enum CampaignStatus {
  ACTIVE
  PAUSED
  ENDED
}

enum SessionStatus {
  STARTED
  IN_PROGRESS
  COMPLETED
  REJECTED
  REWARDED
}

enum LedgerType {
  REWARD
  BONUS
  ADJUSTMENT
}
